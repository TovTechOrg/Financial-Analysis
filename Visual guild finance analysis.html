<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Guide: Startup Financial Analysis Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Visualization & Content Choices: 
        - Report Info: Project tasks, Python code, example financial data (initial investment, cash flows, rates, etc.).
        - Goal: Visualize financial concepts and calculations from the project guide to aid understanding.
        - Viz/Presentation Method:
            - Cash Flows (Task 1.2): Bar chart.
            - NPV Sensitivity (Task 1.4): Line chart with interactive slider for discount rate.
            - IRR vs WACC (Task 2.3): Bar chart.
            - WACC Composition (Task 2.2): Donut chart.
            - Loan Amortization (Task 3.2): Bar chart (stacked).
            - Salary Growth (Task 4.1): Line chart.
            - FV Projections (Task 4.2, 4.4): Displayed values, potentially simple bar charts.
        - Interaction: Tab navigation, Python code toggles, NPV discount rate slider. Charts will be dynamically rendered.
        - Justification: Visuals make complex financial data more accessible. Interactivity (slider) demonstrates concept sensitivity.
        - Library/Method: Chart.js for all charts. Vanilla JS for logic, tabs, interactions. Tailwind CSS for styling.
        - Confirmation: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFBEB; /* amber-50 */
            color: #374151; /* stone-700 / gray-700 */
        }
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            border-bottom-width: 3px;
            border-color: transparent;
        }
        .tab-button.active {
            border-color: #D97706; /* amber-600 */
            color: #D97706; /* amber-600 */
            font-weight: 600;
        }
        .tab-button:not(.active):hover {
            border-color: #FBBF24; /* amber-400 */
            color: #F59E0B; /* amber-500 */
        }
        .task-card {
            border: 1px solid #FDE68A; /* amber-200 */
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: #FFFFFF; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
        }
        .task-card h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            color: #B45309; /* amber-700 */
            margin-bottom: 0.75rem;
        }
        .python-details {
            background-color: #FEF3C7; /* amber-100 */
            border-left: 4px solid #D97706; /* amber-600 */
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.25rem;
        }
        .python-details pre {
            background-color: #1F2937; /* gray-800 */
            color: #D1D5DB; /* gray-300 */
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .python-details code {
            font-family: 'Courier New', Courier, monospace;
        }
        .toggle-button {
            background-color: #FBBF24; /* amber-400 */
            color: #451A03; /* amber-900 */
        }
        .toggle-button:hover {
            background-color: #F59E0B; /* amber-500 */
        }
        .content-section h2 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700;
            color: #92400E; /* amber-800 */
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #FCD34D; /* amber-300 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Default max-width */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Default height */
            max-height: 400px; /* Default max-height */
            padding: 1rem;
            background-color: #FFFAF0; /* FloralWhite, very light cream for chart bg */
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05);
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        /* Responsive chart heights */
        @media (min-width: 640px) { /* sm */
            .chart-container { height: 350px; }
        }
        @media (min-width: 1024px) { /* lg */
            .chart-container { height: 400px; max-height:450px; }
        }

        .interactive-slider-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #78716c; /* stone-500 */
        }
        .interactive-slider-container input[type="range"] {
            width: 100%;
        }
        .interactive-slider-container span {
            font-weight: 600;
            color: #D97706; /* amber-600 */
        }
        .metric-display {
            font-size: 1.125rem;
            font-weight: 600;
            padding: 0.5rem 0;
        }
        .metric-display .value { color: #1D4ED8; } /* blue-700 for values */
        .decision-good { color: #16A34A; font-weight: bold;} /* green-600 */
        .decision-bad { color: #DC2626; font-weight: bold;} /* red-600 */

    </style>
</head>
<body class="text-stone-800">

    <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-amber-700">Visual Guide: Startup Financial Analysis</h1>
            <p class="text-stone-600 mt-3 text-lg">Interactively explore financial concepts from the project guide.</p>
        </header>

        <nav id="tab-navigation" class="mb-10 flex flex-wrap justify-center gap-x-4 sm:gap-x-6 lg:gap-x-8 border-b border-amber-300 pb-2">
            </nav>

        <main id="content-area">
            </main>

        <footer class="text-center mt-16 py-8 border-t border-amber-200">
            <p class="text-sm text-stone-500">&copy; <span id="currentYear"></span> Financial Project Visual Guide. For educational purposes.</p>
        </footer>
    </div>

    <script>
        const projectData = {
            introduction: {
                title: "Introduction",
                content: `
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold text-amber-700 mb-4">Project Overview</h2>
                        <p class="mb-4 text-lg">This interactive guide helps you visualize the "Startup Viability Analyzer & Investment Strategy" project from the <strong>Introduction to Financial Concepts in Python</strong> course.</p>
                        <h3 class="text-xl font-semibold text-amber-600 mb-2">Project Goal:</h3>
                        <p class="mb-4">The original project goal is to build a Python tool to analyze a startup's financial viability. This guide focuses on visualizing the core financial concepts and calculations involved, using the example data from that project.</p>
                        <h3 class="text-xl font-semibold text-amber-600 mb-2">Required Libraries (for original project):</h3>
                        <p class="mb-2">The Python project uses <code>numpy</code> and <code>numpy-financial</code>.</p>
                        <div class="python-details"><pre><code>pip install numpy numpy-financial</code></pre></div>
                        <p class="mt-4 mb-2">This guide uses Chart.js for visualizations.</p>
                        <p class="mt-6 text-stone-600">Use the tabs to navigate. Charts will illustrate key financial data and calculations. Python code for the original project tasks remains available for reference.</p>
                    </div>
                `
            },
            dashboard: {
                title: "ðŸ“Š Dashboard",
                intro: "<p class='mb-6 text-lg text-stone-600'>This dashboard provides a summary of key financial metrics and visualizations based on the example data used throughout the project tasks. It offers a quick overview of the startup's projected financial health and investment attractiveness.</p>",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="task-card">
                            <h3>Key Project Metrics</h3>
                            <div id="dashboard-npv" class="metric-display">NPV (at 15%): <span class="value">Calculating...</span></div>
                            <div id="dashboard-irr" class="metric-display">IRR: <span class="value">Calculating...</span></div>
                            <div id="dashboard-wacc" class="metric-display">WACC: <span class="value">Calculating...</span></div>
                            <div id="dashboard-decision-npv" class="metric-display">NPV Decision (vs WACC): <span class="value"></span></div>
                            <div id="dashboard-decision-irr" class="metric-display">IRR Decision (vs WACC): <span class="value"></span></div>
                        </div>
                        <div class="task-card">
                            <h3>Cash Flow Overview (Years 0-5)</h3>
                            <div class="chart-container" style="height: 280px; max-height:300px;"><canvas id="dashboardCashFlowChart"></canvas></div>
                        </div>
                        <div class="task-card md:col-span-2">
                            <h3>NPV Sensitivity to Discount Rate</h3>
                            <div id="dashboard-npv-interactive-container">
                                </div>
                        </div>
                    </div>
                `
            },
            part1: {
                title: "Part 1: TVM & Initial Setup",
                intro: "<p class='mb-6 text-lg text-stone-600'>This part covers defining the startup, forecasting initial financials, and applying Time Value of Money (TVM) concepts like discount rates, NPV, and inflation adjustments. Visualizations here will help illustrate the projected cash flows and the impact of discounting.</p>",
                tasks: [
                    { id: "task1_1", title: "Task 1.1: Define Your Startup", instruction: "Briefly describe your startup idea. (Conceptual outline). Example: 'GreenThumb AI' for smart garden systems." },
                    { 
                        id: "task1_2", title: "Task 1.2: Forecast Initial Investment & Annual Cash Flows", 
                        instruction: "Estimate initial investment and project annual net cash flows for 5 years.",
                        pythonDetails: { code: `initial_investment = -50000\ncash_flows_annual = np.array([-10000, 5000, 15000, 25000, 40000])` },
                        visualization: { type: 'bar', chartId: 'cashFlowChart', dataKey: 'cashFlows', optionsKey: 'cashFlowOptions', title: 'Projected Cash Flows (Years 0-5)' }
                    },
                    { id: "task1_3", title: "Task 1.3: Define Discount Rate", instruction: "Choose an annual discount rate (e.g., 15% for a startup).", pythonDetails: { code: `discount_rate = 0.15` } },
                    { 
                        id: "task1_4", title: "Task 1.4: Calculate Net Present Value (NPV)", 
                        instruction: "Calculate NPV using the defined discount rate and cash flows.",
                        pythonDetails: { code: `project_cash_flows_all = np.concatenate(([initial_investment], cash_flows_annual))\nnpv = npf.npv(discount_rate, project_cash_flows_all)` },
                        visualization: { type: 'line_interactive_npv', chartId: 'npvSensitivityChartPart1', title: 'NPV Sensitivity to Discount Rate' }
                    },
                    { id: "task1_5", title: "Task 1.5: Adjusting Future Values for Inflation (Optional)", instruction: "Calculate inflation-adjusted Year 5 cash flow. Formula: Real Value = FV / (1 + Inflation Rate)^n.", pythonDetails: { code: `inflation_rate = 0.03\nreal_value_year_5 = cash_flows_annual[-1] / ((1 + inflation_rate)**5)` } }
                ]
            },
            part2: {
                title: "Part 2: Investment Decisions",
                intro: "<p class='mb-6 text-lg text-stone-600'>Here, we delve into metrics like IRR and WACC to make data-driven investment decisions. Visualizations will compare IRR with WACC and illustrate the components of WACC.</p>",
                tasks: [
                    { id: "task2_1", title: "Task 2.1: Calculate Internal Rate of Return (IRR)", instruction: "Calculate IRR for the project's cash flows.", pythonDetails: { code: `irr = npf.irr(project_cash_flows_all)` } },
                    { 
                        id: "task2_2", title: "Task 2.2: The Weighted Average Cost of Capital (WACC)", 
                        instruction: "Calculate WACC based on debt/equity mix, costs, and tax rate. Formula: WACC = (W<sub>E</sub> * C<sub>E</sub>) + (W<sub>D</sub> * C<sub>D</sub> * (1 - T))",
                        pythonDetails: { code: `weight_equity = 0.70; weight_debt = 0.30\ncost_equity = 0.20; cost_debt = 0.07; tax_rate = 0.21\nwacc = (weight_equity * cost_equity) + (weight_debt * cost_debt * (1 - tax_rate))` },
                        visualization: { type: 'doughnut', chartId: 'waccCompositionChart', dataKey: 'waccData', optionsKey: 'waccOptions', title: 'WACC Capital Structure' }
                    },
                    { 
                        id: "task2_3", title: "Task 2.3: Investment Decision Rule", 
                        instruction: "Decide project viability: NPV > 0? IRR > WACC? Recalculate NPV using WACC.",
                        pythonDetails: { code: `npv_using_wacc = npf.npv(wacc, project_cash_flows_all)\n# Decision logic based on npv_using_wacc and irr vs wacc` },
                        visualization: { type: 'bar', chartId: 'irrVsWaccChart', dataKey: 'irrWaccComparisonData', optionsKey: 'irrWaccComparisonOptions', title: 'IRR vs. WACC' }
                    },
                    { id: "task2_4", title: "Task 2.4: Comparing Projects of Different Lifespans (Optional)", instruction: "Use Equivalent Annual Annuity (EAA) for fair comparison. Formula: EAA = (NPV * rate) / (1 - (1 + rate)^-n).", pythonDetails: { code: `# Example for Project A\neaa_a = (npv_using_wacc * wacc) / (1 - (1 + wacc)**-lifespan_project_a)` } }
                ]
            },
            part3: {
                title: "Part 3: Loan Simulation",
                intro: "<p class='mb-6 text-lg text-stone-600'>This part applies loan concepts to business debt. We'll calculate monthly payments and visualize the amortization schedule, showing how payments are split between interest and principal.</p>",
                tasks: [
                    { id: "task3_1", title: "Task 3.1: Calculating Monthly Loan Payments", instruction: "Calculate fixed monthly loan payment. Convert annual rate/term to monthly.", pythonDetails: { code: `loan_amount_startup = -initial_investment * weight_debt\nmonthly_interest_rate_loan = annual_interest_rate_loan / 12\nloan_term_months = loan_term_years * 12\nmonthly_payment_startup_loan = npf.pmt(monthly_interest_rate_loan, loan_term_months, loan_amount_startup)` } },
                    { 
                        id: "task3_2", title: "Task 3.2: Amortization - Interest and Principal", 
                        instruction: "For the first 3 months, calculate interest and principal portions of payments using npf.ipmt() and npf.ppmt().",
                        pythonDetails: { code: `interest_payment_period = npf.ipmt(monthly_interest_rate_loan, period, loan_term_months, loan_amount_startup)\nprincipal_payment_period = npf.ppmt(monthly_interest_rate_loan, period, loan_term_months, loan_amount_startup)` },
                        visualization: { type: 'bar', chartId: 'loanAmortizationChart', dataKey: 'amortizationData', optionsKey: 'amortizationOptions', title: 'Loan Amortization (First 3 Months)' }
                    }
                ]
            },
            part4: {
                title: "Part 4: Personal Investment",
                intro: "<p class='mb-6 text-lg text-stone-600'>Focus shifts to the founder's personal investment perspective, including salary forecasts, investment growth, and a simplified net worth projection. Visuals will illustrate salary progression and investment returns.</p>",
                tasks: [
                    { 
                        id: "task4_1", title: "Task 4.1: Personal Investment & Salary Forecast", 
                        instruction: "Define personal investment. Forecast annual salary (e.g., from Year 2, growing annually).",
                        pythonDetails: { code: `personal_investment_amount = 20000\ninitial_salary_year2 = 30000; salary_growth_rate = 0.05\nsalaries = [0, 30000, 31500, 33075, 34728.75] # Example for Y1-Y5` },
                        visualization: { type: 'line', chartId: 'salaryForecastChart', dataKey: 'salaryData', optionsKey: 'salaryOptions', title: 'Projected Annual Salary (Years 1-5)' }
                    },
                    { id: "task4_2", title: "Task 4.2: Forecasting Growth of Personal Investment", instruction: "Project Future Value (FV) of personal investment after 5 years (e.g., growing at IRR or market rate).", pythonDetails: { code: `fv_personal_investment = npf.fv(growth_rate_personal_investment, 5, 0, -personal_investment_amount)` } },
                    { id: "task4_3", title: "Task 4.3: Net Worth Projection (Simplified)", instruction: "Calculate simplified projected net worth after 5 years.", pythonDetails: { code: `projected_net_worth = initial_net_worth - personal_inv + fv_personal_inv + cumulative_salary` } },
                    { id: "task4_4", title: "Task 4.4: Impact of Investing Salary Percentage (Optional)", instruction: "Calculate FV of investing a percentage of salary annually.", pythonDetails: { code: `# Loop to calculate FV of each year's salary investment and sum up` } }
                ]
            },
            conclusion: {
                title: "Conclusion & Reflection",
                content: `
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold text-amber-700 mb-4">Project Conclusion & Reflection</h2>
                        <p class="mb-4 text-lg">After working through the project tasks (using your own Python notebook) and exploring the visualizations in this guide, reflect on your findings:</p>
                        <ul class="list-disc list-inside space-y-2 text-stone-600 mb-4">
                            <li>Was the startup project financially viable based on the example data and your chosen parameters?</li>
                            <li>How sensitive were metrics like NPV to changes in the discount rate?</li>
                            <li>What are the key takeaways from visualizing cash flows, WACC, loan amortization, and personal financial projections?</li>
                            <li>What are the limitations of such financial models?</li>
                        </ul>
                        <p class="text-stone-600">This interactive guide aims to enhance your understanding of these financial concepts by making them more visual and dynamic.</p>
                    </div>
                `
            }
        };
        
        const exampleFinancialData = {
            initialInvestment: -50000,
            annualCashFlows: [-10000, 5000, 15000, 25000, 40000],
            baseDiscountRate: 0.15,
            inflationRate: 0.03,
            weightEquity: 0.70,
            weightDebt: 0.30,
            costEquity: 0.20,
            costDebt: 0.07,
            taxRate: 0.21,
            loanTermYears: 3,
            personalInvestment: 20000,
            initialSalaryY2: 30000,
            salaryGrowthRate: 0.05,
        };

        let charts = {}; 

        function destroyChart(chartId) {
            if (charts[chartId]) {
                charts[chartId].destroy();
                delete charts[chartId];
            }
        }
        
        function formatCurrency(value) {
            if (isNaN(value)) return 'N/A';
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }

        function calculateNpv(rate, cashflows) {
            let npv = cashflows[0]; 
            for (let i = 1; i < cashflows.length; i++) {
                npv += cashflows[i] / Math.pow((1 + rate), i);
            }
            return npv;
        }
        
        function calculateIrr(cashflows, guess = 0.1, maxIterations = 1000, tolerance = 1e-7) {
            let x0 = guess;
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dnpv_dr = 0; 
                for (let t = 0; t < cashflows.length; t++) {
                    npv += cashflows[t] / Math.pow(1 + x0, t);
                    if (t > 0) { 
                        dnpv_dr -= t * cashflows[t] / Math.pow(1 + x0, t + 1);
                    }
                }
                if (Math.abs(npv) < tolerance) return x0;
                if (dnpv_dr === 0) break; 
                let x1 = x0 - npv / dnpv_dr;
                if (Math.abs(x1 - x0) < tolerance) return x1;
                x0 = x1;
            }
            return NaN; 
        }


        function getChartData(key) {
            const allCashFlows = [exampleFinancialData.initialInvestment, ...exampleFinancialData.annualCashFlows];
            const waccVal = (exampleFinancialData.weightEquity * exampleFinancialData.costEquity) + 
                           (exampleFinancialData.weightDebt * exampleFinancialData.costDebt * (1 - exampleFinancialData.taxRate));

            switch(key) {
                case 'cashFlows':
                    return {
                        labels: ['Year 0', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'],
                        datasets: [{
                            label: 'Net Cash Flow',
                            data: allCashFlows,
                            backgroundColor: allCashFlows.map(cf => cf < 0 ? 'rgba(255, 99, 132, 0.7)' : 'rgba(75, 192, 192, 0.7)'),
                            borderColor: allCashFlows.map(cf => cf < 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)'),
                            borderWidth: 1
                        }]
                    };
                case 'waccData':
                    return {
                        labels: [`Equity (${(exampleFinancialData.weightEquity*100).toFixed(0)}%)`, `Debt (${(exampleFinancialData.weightDebt*100).toFixed(0)}%)`],
                        datasets: [{
                            label: 'Capital Structure',
                            data: [exampleFinancialData.weightEquity, exampleFinancialData.weightDebt],
                            backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 159, 64, 0.7)'],
                            borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 159, 64, 1)'],
                            borderWidth: 1
                        }]
                    };
                case 'irrWaccComparisonData':
                    const irrVal = calculateIrr(allCashFlows);
                    return {
                        labels: ['IRR', 'WACC'],
                        datasets: [{
                            label: 'Rate Comparison',
                            data: [isNaN(irrVal) ? 0 : irrVal * 100, waccVal * 100], 
                            backgroundColor: ['rgba(153, 102, 255, 0.7)', 'rgba(255, 206, 86, 0.7)'],
                            borderColor: ['rgba(153, 102, 255, 1)', 'rgba(255, 206, 86, 1)'],
                            borderWidth: 1
                        }]
                    };
                case 'amortizationData':
                    const loanAmount = -exampleFinancialData.initialInvestment * exampleFinancialData.weightDebt;
                    const monthlyRate = exampleFinancialData.costDebt / 12;
                    const numMonths = exampleFinancialData.loanTermYears * 12;
                    const pmt = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, numMonths)) / (Math.pow(1 + monthlyRate, numMonths) - 1);

                    let principalPayments = [], interestPayments = [];
                    let balance = loanAmount;
                    for (let i=1; i<=3; i++) {
                        let interest = balance * monthlyRate;
                        let principal = pmt - interest;
                        interestPayments.push(interest);
                        principalPayments.push(principal);
                        balance -= principal;
                    }
                    return {
                        labels: ['Month 1', 'Month 2', 'Month 3'],
                        datasets: [
                            { label: 'Principal', data: principalPayments, backgroundColor: 'rgba(75, 192, 192, 0.7)' },
                            { label: 'Interest', data: interestPayments, backgroundColor: 'rgba(255, 99, 132, 0.7)' }
                        ]
                    };
                case 'salaryData':
                    let salaries = [0, exampleFinancialData.initialSalaryY2];
                    for(let i=2; i<=4; i++) salaries.push(salaries[i-1]*(1+exampleFinancialData.salaryGrowthRate));
                     return {
                        labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'],
                        datasets: [{
                            label: 'Projected Salary',
                            data: salaries,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    };
                default: return {};
            }
        }

        function getChartOptions(key) {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                     if (key === 'irrWaccComparisonOptions' || key === 'npvSensitivityOptions') label += context.parsed.y.toFixed(2) + (key === 'irrWaccComparisonOptions' ? '%' : ''); // NPV sensitivity also shows % for rates on x-axis, actual value for y
                                     else label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: { 
                    y: { ticks: { callback: function(value, index, ticks) { 
                        if (key === 'irrWaccComparisonOptions') return value.toFixed(1) + '%';
                        if (key === 'npvSensitivityOptions' && ticks[index] && typeof ticks[index].label === 'string' && ticks[index].label.includes('%')) return formatCurrency(value); // Special handling for NPV y-axis
                        return formatCurrency(value);
                    }}} 
                }
            };
             if (key === 'npvSensitivityOptions') { // Specific for NPV sensitivity chart's x-axis
                baseOptions.scales.x = { title: { display: true, text: 'Discount Rate' } };
            }

            switch(key) {
                case 'cashFlowOptions': return baseOptions;
                case 'waccOptions': return { ...baseOptions, cutout: '50%'};
                case 'irrWaccComparisonOptions': return baseOptions;
                case 'amortizationOptions': return { ...baseOptions, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: value => formatCurrency(value) } } } };
                case 'salaryOptions': return baseOptions;
                case 'npvSensitivityOptions': return baseOptions;
                default: return baseOptions;
            }
        }
        
        function renderNpvSensitivityChart(canvasId, currentDiscountRate) {
            destroyChart(canvasId);
            const canvasElement = document.getElementById(canvasId);
            if (!canvasElement) return;
            const ctx = canvasElement.getContext('2d');
            const allCashFlows = [exampleFinancialData.initialInvestment, ...exampleFinancialData.annualCashFlows];
            
            const rates = Array.from({length: 31}, (_, i) => i * 0.01); 
            const npvs = rates.map(rate => calculateNpv(rate, allCashFlows));

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rates.map(r => (r*100).toFixed(0) + '%'),
                    datasets: [{
                        label: 'NPV',
                        data: npvs,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: rates.map(r => Math.abs(r - currentDiscountRate) < 0.001 ? 6 : 3),
                        pointBackgroundColor: rates.map(r => Math.abs(r - currentDiscountRate) < 0.001 ? 'red' : 'rgba(75, 192, 192, 1)')
                    }]
                },
                options: getChartOptions('npvSensitivityOptions')
            });
        }
        
        function createInteractiveNpvSectionHTML(chartId, title) {
            return `
                <div class="interactive-slider-container mb-3 p-3 bg-amber-50 rounded-md">
                    <label for="discountRateSlider-${chartId}">Adjust Discount Rate: <span id="discountRateValue-${chartId}">${(exampleFinancialData.baseDiscountRate * 100).toFixed(0)}%</span></label>
                    <input type="range" id="discountRateSlider-${chartId}" min="0" max="30" value="${exampleFinancialData.baseDiscountRate * 100}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
                    <div id="npvDisplay-${chartId}" class="metric-display mt-2">Calculated NPV: <span class="value"></span></div>
                </div>
                <div class="chart-container">
                    ${title ? `<p class="text-center font-semibold text-stone-700 mb-2">${title}</p>` : ''}
                    <canvas id="${chartId}"></canvas>
                </div>
            `;
        }

        function initInteractiveNpvSection(containerId, chartId) {
            const slider = document.getElementById(`discountRateSlider-${chartId}`);
            const rateValueDisplay = document.getElementById(`discountRateValue-${chartId}`);
            const npvDisplayValue = document.getElementById(`npvDisplay-${chartId}`)?.querySelector('.value'); // Added optional chaining
            
            if (!slider || !rateValueDisplay || !npvDisplayValue) {
                console.error("One or more elements for interactive NPV section not found for chartId:", chartId, "within container:", containerId);
                return;
            }
            
            const allCashFlows = [exampleFinancialData.initialInvestment, ...exampleFinancialData.annualCashFlows];

            function updateNpvVisuals(rate) {
                const currentNpv = calculateNpv(rate, allCashFlows);
                npvDisplayValue.textContent = formatCurrency(currentNpv);
                rateValueDisplay.textContent = (rate * 100).toFixed(0) + '%';
                renderNpvSensitivityChart(chartId, rate);
            }

            slider.oninput = function() {
                const newRate = parseFloat(this.value) / 100;
                updateNpvVisuals(newRate);
            };
            updateNpvVisuals(exampleFinancialData.baseDiscountRate); 
        }


        const tabNavigation = document.getElementById('tab-navigation');
        const contentArea = document.getElementById('content-area');

        function createTabButton(id, text, isFirst = false) {
            const button = document.createElement('button');
            button.id = `${id}-tab`;
            button.className = `tab-button py-2 px-4 sm:py-2 sm:px-5 rounded-t-md font-medium text-sm sm:text-base focus:outline-none`;
            if(isFirst) button.classList.add('active');
            button.textContent = text;
            button.onclick = () => showContent(id);
            return button;
        }

        function createTaskCard(task) {
            let pythonSection = '';
            if (task.pythonDetails) {
                pythonSection = `
                    <button id="toggle-${task.id}" class="toggle-button mt-3 py-2 px-4 rounded-md text-sm font-medium shadow-sm">
                        Show Python Implementation
                    </button>
                    <div id="details-${task.id}" class="python-details hidden mt-3">
                        ${task.pythonDetails.guidance ? `<p class="mb-2 text-sm text-stone-600">${task.pythonDetails.guidance}</p>` : ''}
                        <pre><code>${task.pythonDetails.code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>
                    </div>
                `;
            }
            
            const card = document.createElement('div');
            card.className = 'task-card';
            card.innerHTML = `
                <h3 class="text-xl font-semibold text-amber-600">${task.title}</h3>
                <div class="text-stone-600 text-sm leading-relaxed">${task.instruction}</div>
                ${pythonSection}
            `;

            if (task.visualization) {
                if (task.visualization.type === 'line_interactive_npv') {
                    const interactiveNpvHTML = createInteractiveNpvSectionHTML(task.visualization.chartId, task.visualization.title);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = interactiveNpvHTML;
                    while(tempDiv.firstChild) {
                        card.appendChild(tempDiv.firstChild);
                    }
                } else {
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    if (task.visualization.title) {
                        const titleEl = document.createElement('p');
                        titleEl.className = 'text-center font-semibold text-stone-700 mb-2';
                        titleEl.textContent = task.visualization.title;
                        chartContainer.appendChild(titleEl);
                    }
                    const canvas = document.createElement('canvas');
                    canvas.id = task.visualization.chartId;
                    chartContainer.appendChild(canvas);
                    card.appendChild(chartContainer);
                }
            }
            return card;
        }
        
        function renderAllChartsForSection(sectionData) {
            if (sectionData.tasks) {
                sectionData.tasks.forEach(task => {
                    if (task.visualization) {
                        if (task.visualization.type === 'line_interactive_npv') {
                            initInteractiveNpvSection(task.id, task.visualization.chartId); // Initialize after card is in DOM
                        } else {
                            destroyChart(task.visualization.chartId);
                            const ctx = document.getElementById(task.visualization.chartId)?.getContext('2d');
                            if (ctx) {
                               charts[task.visualization.chartId] = new Chart(ctx, {
                                    type: task.visualization.type,
                                    data: getChartData(task.visualization.dataKey),
                                    options: getChartOptions(task.visualization.optionsKey)
                                });
                            }
                        }
                    }
                });
            }
            if (sectionData.title === "ðŸ“Š Dashboard") {
                renderDashboardContent();
            }
        }

        function renderDashboardContent() {
            const allCashFlows = [exampleFinancialData.initialInvestment, ...exampleFinancialData.annualCashFlows];
            const baseNpv = calculateNpv(exampleFinancialData.baseDiscountRate, allCashFlows);
            const irrVal = calculateIrr(allCashFlows);
            const waccVal = (exampleFinancialData.weightEquity * exampleFinancialData.costEquity) + 
                           (exampleFinancialData.weightDebt * exampleFinancialData.costDebt * (1 - exampleFinancialData.taxRate));
            const npvAtWacc = calculateNpv(waccVal, allCashFlows);

            const dashboardNpvEl = document.getElementById('dashboard-npv')?.querySelector('.value');
            if(dashboardNpvEl) dashboardNpvEl.textContent = formatCurrency(baseNpv);
            
            const dashboardIrrEl = document.getElementById('dashboard-irr')?.querySelector('.value');
            if(dashboardIrrEl) dashboardIrrEl.textContent = isNaN(irrVal) ? 'N/A' : (irrVal * 100).toFixed(2) + '%';

            const dashboardWaccEl = document.getElementById('dashboard-wacc')?.querySelector('.value');
            if(dashboardWaccEl) dashboardWaccEl.textContent = (waccVal * 100).toFixed(2) + '%';
            
            const npvDecisionEl = document.getElementById('dashboard-decision-npv')?.querySelector('.value');
            if(npvDecisionEl) {
                npvDecisionEl.textContent = npvAtWacc > 0 ? `Accept (${formatCurrency(npvAtWacc)})` : `Reject (${formatCurrency(npvAtWacc)})`;
                npvDecisionEl.className = `value ${npvAtWacc > 0 ? 'decision-good' : 'decision-bad'}`;
            }

            const irrDecisionEl = document.getElementById('dashboard-decision-irr')?.querySelector('.value');
            if(irrDecisionEl) {
                irrDecisionEl.textContent = !isNaN(irrVal) && irrVal > waccVal ? `Accept (${(irrVal*100).toFixed(2)}% > ${(waccVal*100).toFixed(2)}%)` : `Reject (IRR: ${isNaN(irrVal) ? 'N/A' : (irrVal*100).toFixed(2)}% vs WACC: ${(waccVal*100).toFixed(2)}%)`;
                irrDecisionEl.className = `value ${!isNaN(irrVal) && irrVal > waccVal ? 'decision-good' : 'decision-bad'}`;
            }

            destroyChart('dashboardCashFlowChart');
            const cfCtx = document.getElementById('dashboardCashFlowChart')?.getContext('2d');
            if(cfCtx) charts['dashboardCashFlowChart'] = new Chart(cfCtx, { type: 'bar', data: getChartData('cashFlows'), options: getChartOptions('cashFlowOptions') });
            
            // Inject and initialize interactive NPV for dashboard
            const dashboardNpvContainer = document.getElementById('dashboard-npv-interactive-container');
            if (dashboardNpvContainer) {
                dashboardNpvContainer.innerHTML = createInteractiveNpvSectionHTML('dashboardNpvsensitivityChart', 'NPV Sensitivity to Discount Rate'); // No title needed if already in card h3
                initInteractiveNpvSection('dashboard-npv-interactive-container', 'dashboardNpvsensitivityChart');
            }
        }


        function showContent(id) {
            contentArea.innerHTML = ''; 
            Object.values(charts).forEach(chart => { if(chart) chart.destroy(); }); 
            charts = {};
            
            const sectionData = projectData[id];
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `${id}-content`;
            sectionDiv.className = 'content-section animate-fadeIn'; 

            let contentHTML = `<h2 class="text-3xl font-bold text-amber-700 mb-6 pb-2 border-b-2 border-amber-300">${sectionData.title}</h2>`;
            
            if (sectionData.intro) contentHTML += sectionData.intro;
            if (sectionData.content && id !== 'dashboard') { // Dashboard content is handled differently
                 contentHTML += sectionData.content;
            } else if (id === 'dashboard' && sectionData.content) {
                 sectionDiv.innerHTML = contentHTML + sectionData.content; // Set base HTML for dashboard
            }
            
            if (id !== 'dashboard') sectionDiv.innerHTML = contentHTML;


            if (sectionData.tasks) { 
                sectionData.tasks.forEach(task => {
                    sectionDiv.appendChild(createTaskCard(task));
                });
            }
            
            contentArea.appendChild(sectionDiv);
            
            renderAllChartsForSection(sectionData);


            if (sectionData.tasks) {
                sectionData.tasks.forEach(task => {
                    if (task.pythonDetails) {
                        const toggleButton = document.getElementById(`toggle-${task.id}`);
                        const detailsDiv = document.getElementById(`details-${task.id}`);
                        if (toggleButton && detailsDiv) {
                            toggleButton.onclick = () => {
                                const isHidden = detailsDiv.classList.toggle('hidden');
                                toggleButton.textContent = isHidden ? 'Show Python Implementation' : 'Hide Python Implementation';
                            };
                        }
                    }
                });
            }

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${id}-tab`)?.classList.add('active');
        }

        function initTabs() {
            const tabOrder = ['dashboard', 'introduction', 'part1', 'part2', 'part3', 'part4', 'conclusion'];
            tabOrder.forEach((key, index) => {
                const section = projectData[key];
                if (section) {
                    tabNavigation.appendChild(createTabButton(key, section.title, index === 0));
                }
            });
            if (tabOrder.length > 0) {
                showContent(tabOrder[0]); 
            }
        }
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        initTabs();

    </script>
</body>
</html>
